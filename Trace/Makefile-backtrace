#
# Makefile
#
# Makefile for backtrace
#

.PHONY: all install configure clean distclean

#
# Determine operating system and architecture
#
ifndef OSNAME
OSNAME := $(shell uname)
endif
ifndef OSARCH
OSARCH := $(subst /,-,$(shell uname -m | tr ' ' _))
endif

BTINCPREFIX := $(POCO_BASE)/Trace/include/Poco/Trace/backtrace
BTLIBPREFIX := $(POCO_BASE)/lib/$(OSNAME)/$(OSARCH)
BTLIBNAME   := libbacktrace
BTEXTENSION := so.0.0.0
BTCOPYFILES := cp -f "$(BTLIBPREFIX)/lib/$(BTLIBNAME).a" "$(BTLIBPREFIX)/" && \
cp -f "$(BTLIBPREFIX)/lib/$(BTLIBNAME).la" "$(BTLIBPREFIX)/" && \
cp -f "$(BTLIBPREFIX)/lib/$(BTLIBNAME).$(BTEXTENSION)" "$(BTLIBPREFIX)/" && \
ln -sf "$(BTLIBPREFIX)/$(BTLIBNAME).$(BTEXTENSION)" "$(BTLIBPREFIX)/$(BTLIBNAME).so.0" && \
ln -sf "$(BTLIBPREFIX)/$(BTLIBNAME).$(BTEXTENSION)" "$(BTLIBPREFIX)/$(BTLIBNAME).so"

all: install

install: configure
	$(MAKE) -C $(BTLIBNAME) $(MAKECMDGOALS) $(MAKEARGS)
	$(BTCOPYFILES)

configure:
	$(shell [ ! -f "$(BTLIBNAME)/Makefile" ] && \
	cd $(BTLIBNAME) && \
	./configure --bindir=$(BTLIBPREFIX) --exec-prefix=$(BTLIBPREFIX) --libexecdir=$(BTLIBPREFIX) --includedir=$(BTINCPREFIX) --enable-shared=yes && \
	"cd ..")

clean:
	$(MAKE) -C libbacktrace clean

distclean:
	$(MAKE) -C libbacktrace distclean
